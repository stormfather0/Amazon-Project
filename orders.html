<!DOCTYPE html>
<html lang="en">
<head>
    <title>Orders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS Styles -->
    <link rel="stylesheet" href="styles/shared/general.css">
    <link rel="stylesheet" href="styles/shared/amazon-header.css">
    <link rel="stylesheet" href="styles/pages/orders.css">
</head>
<body>
    <!-- Amazon Header -->
    <div class="amazon-header">
        <div class="amazon-header-left-section">
            <a href="amazon.html" class="header-link">
                <img class="amazon-logo" src="images/amazon-logo-white.png">
                <img class="amazon-mobile-logo" src="images/amazon-mobile-logo-white.png">
            </a>
        </div>
        <div class="amazon-header-middle-section">
            <input class="search-bar" type="text" placeholder="Search">
            <button class="search-button">
                <img class="search-icon" src="images/icons/search-icon.png">
            </button>
        </div>
        <div class="amazon-header-right-section">
            <a class="orders-link header-link" href="orders.html">
                <span class="returns-text">Returns</span>
                <span class="orders-text">& Orders</span>
            </a>
            <a class="cart-link header-link" href="checkout.html">
                <img class="cart-icon" src="images/icons/cart-icon.png">
                <div class="cart-quantity">3</div>
                <div class="cart-text">Cart</div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="page-title">Your Orders</div>
        <div class="orders-grid" id="orders-container">
            <!-- Orders will be inserted here dynamically -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', fetchOrders);

        async function fetchOrders() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                document.getElementById('orders-container').innerHTML = '<p>Please log in to view orders.</p>';
                return;
            }

            try {
                const response = await fetch('https://amazon-project-sta4.onrender.com/api/user-orders', {
                    method: 'GET',
                    headers: { 'Authorization': `${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch orders');
                
                const orders = await response.json();
                const ordersContainer = document.getElementById('orders-container');

                if (orders.length === 0) {
                    ordersContainer.innerHTML = '<p>No orders found.</p>';
                    return;
                }

                ordersContainer.innerHTML = orders.map(order => `
                    <div class="order-container">
                        <div class="order-header">
                            <div class="order-header-left-section">
                                <div class="order-date">
                                    <div class="order-header-label">Order Placed:</div>
                                    <div>${new Date(order.createdAt).toLocaleDateString()}</div>
                                </div>
                                <div class="order-total">
                                    <div class="order-header-label">Total:</div>
                                    <div>$${order.total.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="order-header-right-section">
                                <div class="order-header-label">Order ID:</div>
                                <div>${order._id}</div>
                            </div>
                        </div>
                        <div class="order-details-grid">
                            ${order.items.map(item => `
                                <div class="product-image-container">
                                    <img src="${item.imageUrl || 'images/products/placeholder.png'}">
                                </div>
                                <div class="product-details">
                                    <div class="product-name">${item.name}</div>
                                    <div class="product-delivery-date">
                                        Arriving on: ${order.deliveryOptions[0]?.date || 'TBD'}
                                    </div>
                                    <div class="product-quantity">Quantity: ${item.quantity}</div>
                                    <button class="buy-again-button button-primary">
                                        <img class="buy-again-icon" src="images/icons/buy-again.png">
                                        <span class="buy-again-message">Buy it again</span>
                                    </button>
                                </div>
                                <div class="product-actions">
                                    <a href="tracking.html">
                                        <button class="track-package-button button-secondary">
                                            Track package
                                        </button>
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('orders-container').innerHTML = '<p>Error fetching orders.</p>';
            }
        }
    </script>
</body>
</html>